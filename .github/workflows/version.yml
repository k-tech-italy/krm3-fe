name: Version Check

on:
  workflow_run:
    workflows: ["Run Tests with Coverage"]
    types: [completed]
    branches: [master, feature/github-actions]

jobs:
  version-check:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout current code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Fetch current and previuos

      - name: Check versions
        run: |
          CURRENT=$(grep '"version"' package.json | cut -d'"' -f4)
          PREVIOUS=$(git show HEAD~1:package.json | grep '"version"' | cut -d'"' -f4)

          echo "Previous: $PREVIOUS"
          echo "Current: $CURRENT"

          if [[ "$CURRENT" == "$PREVIOUS" ]]; then
            echo "❌ Version not incremented! Still $CURRENT"
            exit 1
          elif [[ "$CURRENT" > "$PREVIOUS" ]]; then
            echo "✅ Version incremented: $PREVIOUS → $CURRENT"
          else
            echo "❌ Version decreased: $PREVIOUS → $CURRENT"
            exit 1
          fi

      - name: Version check passed
        run: |
          echo "🎉 Version check passed! Ready to proceed with deployment or further steps."
